pipeline {
    agent any
    
    stages() {
        stage('remove existing container') {
            steps{
                script{
                    try {
                        sh "docker stop joblog-client"
                        sh "docker rm joblog-client"

                        sh "docker stop joblog-server"
                        sh "docker rm joblog-server"
                        
                        sh "docker rmi minsu10/joblog-server:latest"
                        sh "docker rmi minsu10/joblog-client:latest"
                    }
                    catch (Exception e) {
                        echo 'Exception occurred: ' + e.toString()
                        sh 'Handle the exception!'
                    }
                }
            }
        }
        
        stage('client build') {
            steps {
                dir('front'){
                    sh "docker build -t minsu10/joblog-client ."
                }
            }
        }
        stage('server build') {
            steps {
                dir('backend'){
                    sh "docker build -t minsu10/joblog-server ."
                }
            }
        } 
        stage('push docker hub') {
            steps {
                sh "docker push minsu10/joblog-client"
                sh "docker push minsu10/joblog-server"
            }
        }   
        stage('run') {
            steps {
                

                sh "docker run -d -p 80:80 --name joblog-client minsu10/joblog-client"
                sh "docker run -d -p 5000:5000 --name joblog-server minsu10/joblog-server"
            }
        }   
        
            
    }
}